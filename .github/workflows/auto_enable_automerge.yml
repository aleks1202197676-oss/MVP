name: Auto-enable auto-merge

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, labeled]

permissions:
  pull-requests: write
  contents: write

jobs:
  enable-automerge:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate PR and enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const isOptIn = (pr) => {
              const title = pr.title || "";
              const branch = pr.head?.ref || "";
              return title.startsWith("PR-") || branch.startsWith("pr-") || branch.startsWith("codex/");
            };

            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            let pr = context.payload.pull_request;

            if (!isOptIn(pr)) {
              core.info("PR does not match auto-merge opt-in naming rules (title/branch). Skipping.");
              return;
            }

            for (let attempt = 0; attempt < 2 && pr.mergeable_state === "unknown"; attempt++) {
              core.info(`mergeable_state is unknown (attempt ${attempt + 1}/2). Retrying shortly...`);
              await sleep(2000);
              const refreshed = await github.rest.pulls.get({ owner, repo, pull_number });
              pr = refreshed.data;
            }

            if (pr.mergeable_state === "dirty" || pr.mergeable_state === "blocked") {
              core.info(`mergeable_state is ${pr.mergeable_state}. Auto-merge will not be enabled.`);
              return;
            }

            if (pr.mergeable_state === "unknown") {
              core.info("mergeable_state remained unknown after retries. Skipping for now.");
              return;
            }

            await github.graphql(
              `mutation EnableAutoMerge($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }) {
                  pullRequest { id number }
                }
              }`,
              { pullRequestId: pr.node_id }
            );

            core.info(`Auto-merge enabled (squash) for PR #${pull_number}.`);
